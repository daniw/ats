\documentclass[a4,paper,fleqn]{article}

\usepackage{layout}


\title{Automatisierungstechnik -- Labor Aufgabenserie 7}
\date{\today}
\author{Yves Studer\\Daniel Winz}

\begin{document}
\maketitle
\clearpage
\section{Diskretisierung Regler}
Der Ausgang setzt sich aus den Anteilen $U_p$, $U_i$ und $U_d$ zusammen. 
\[ U[k] = U_p[k] + U_i[k] + U_d[k] \]

\subsection{P Anteil}
\[ H_p(s) = K_p \]
\[ H_p(z) = K_p \]
\[ U_p[k] = E_p[k] \cdot K_p \]

\subsection{I Anteil}
\[ H_i(s) = \frac{K_p}{T_i \cdot s} \]
Trapezregel
\[ s = \frac{2}{T} \cdot \frac{z - 1}{z + 1} \]
\[ H_i(z) = \frac{K_p}{T_i \cdot \dfrac{2}{T} \cdot \dfrac{z - 1}{z + 1}}
 = \frac{K_p \cdot T \cdot (z + 1)}{T_i \cdot 2 \cdot (z - 1)}
 = \frac{K_p \cdot T \cdot z + K_p \cdot T}{T_i \cdot 2 \cdot z - T_i \cdot 2}
 = \frac{K_p \cdot T + K_p \cdot T \cdot z^{-1}}{T_i \cdot 2 - T_i \cdot 2 \cdot z^{-1}}
 = \frac{U_i(z)}{E(z)} \]
\[ U_i(z) \cdot (T_i \cdot 2 - T_i \cdot 2 \cdot z^{-1})
 = E(z) \cdot (K_p \cdot T + K_p \cdot T \cdot z^{-1}) \]
\[ U_i[k] =  U_i[k-1] + \left(E[k] + E[k-1]\right) \cdot
 \underbrace{\frac{K_p \cdot T}{2 \cdot T_i}}_{K_i} \]

\subsection{I Anteil mit Anti-Reset Windup}
Rechnung gleich wie ohne ARW
\[ U_i[k] =  U_i[k-1] + \left(E[k] + E[k-1]\right) \cdot
 \underbrace{\frac{K_p \cdot T}{2 \cdot T_i}}_{K_i}
 + \left(U_{Sat}[k] - U[k] + U_{Sat}[k-1] - U[k-1]\right) \cdot
 \underbrace{\frac{T}{2 \cdot T_r}}_{K_r} \]

\subsection{D Anteil}
\[ H_d(s) = - \frac{T_d \cdot s}{\dfrac{T_d}{N} \cdot s + 1} \]
Rückwärtsrechteckregel
\[ s = \frac{z - 1}{t \cdot z} \]
\[ H_d(z) = -\frac{T_d \cdot \dfrac{z - 1}{t \cdot z}}{\dfrac{T_d}{N} \cdot \dfrac{z - 1}{t \cdot z} + 1}
 = -\frac{T_d \cdot N \cdot (z - 1)}{T_d \cdot (z - 1) + N \cdot t \cdot z}
 = -\frac{T_d \cdot N \cdot z - T_d \cdot N}{T_d \cdot z + N \cdot t \cdot z - T_d} \]
\[ H_d(z) = -\frac{T_d \cdot N - T_d \cdot N \cdot z^{-1}}{T_d + N \cdot t - T_d \cdot z^{-1}}
 = \frac{U_d(z)}{E(z)} \]
\[ U_d(z) \cdot (T_d + N \cdot t - T_d \cdot z^{-1})
 = - E(z) \cdot (T_d \cdot N - T_d \cdot N \cdot z^{-1}) \]
\[ U_d[k] = U_d[k-1] \cdot \frac{T_d}{T_d + N \cdot t}
 - \left(E[k] - E[k-1]\right) \cdot \frac{T_d}{T_d + N \cdot t} \cdot N \]
\[ U_d[k] = \underbrace{\frac{1}{1 + \dfrac{N \cdot t}{T_d}}}_{K_d} \cdot \left(U_d[k-1]
 - \left(E[k] - E[k-1]\right) \cdot N\right) \]

\section{Implementierung}
\lstsettingst
\begin{lstlisting}
FUNCTION_BLOCK PID
VAR_INPUT
	input_e : REAL;
	input_y : REAL;
	param : PID_Parameter_Struct;
	modus : System_Modus_Enum;
END_VAR

VAR_OUTPUT
	out: REAL;
END_VAR

VAR
	p : REAL;
	i : REAL;
	d : REAL;
	Ki : REAL;
	Kd : REAL;
	Kr : REAL;
	input_e_z1 : REAL;
	input_y_z1 : REAL;
	i_z1 : REAL;
	d_z1 : REAL;
	out_z1_sat : REAL;
	out_arw : REAL;
	out_arw_z1 : REAL;
	out_z1 : REAL;
END_VAR

CASE modus OF
System_init:
	Ki := param.Kp * PERIOD / (2 * param.Ti);
	Kd := 1 / (1 + (param.N * PERIOD) / (param.Td));
	Kr := PERIOD / (param.Tr * 2);

System_run:
	p := input_e * param.Kp;
	IF param.ARW = 0 THEN
		(* No anti-reset windup *)
		i   := i_z1 + Ki * (input_e + input_e_z1);
	ELSE
		(* anti-reset windup enabled *)
		IF out_z1 > param.Umax THEN
			out_z1_sat := param.Umax;
		ELSIF out_z1 > param.Umax THEN
			out_z1_sat := param.Umin;
		ELSE
			out_z1_sat := out_z1;
		END_IF
		out_arw := out_z1_sat - out_z1;
		i := i_z1 + Ki * (input_e + input_e_z1) + Kr * (out_arw + out_arw_z1);
	END_IF;
	d := Kd * (d_z1 - (input_y - input_y_z1) * param.N);

	out := p + i + d;

	input_e_z1 := input_e;
	input_y_z1 := input_y;
	i_z1 := i;
	d_z1 := d;
	out_arw_z1 := out_arw;
	out_z1 := out;
END_CASE
\end{lstlisting}

\clearpage

\section{Messung}
\begin{figure}[h!]
    \begin{minipage}{0.45\textwidth}
        \centering
        \includegraphics[width=1.0\textwidth]{../matlab/off_0_90.pdf}
        \subcaption{Sprungantwort ohne ARW 0 \ldots 90}
        \label{fig:off_0_90}
    \end{minipage}
    \begin{minipage}{0.45\textwidth}
        \centering
        \includegraphics[width=1.0\textwidth]{../matlab/off_90_0.pdf}
        \subcaption{Sprungantwort ohne ARW 90 \ldots 0}
        \label{fig:off_0_90}
    \end{minipage}
    \caption{Sprungantwort ohne ARW}
    \label{fig:off}
\end{figure}
\begin{figure}[h!]
    \begin{minipage}{0.45\textwidth}
        \centering
        \includegraphics[width=1.0\textwidth]{../matlab/on_0_90.pdf}
        \subcaption{Sprungantwort mit ARW 0 \ldots 90}
        \label{fig:on_0_90}
    \end{minipage}
    \begin{minipage}{0.45\textwidth}
        \centering
        \includegraphics[width=1.0\textwidth]{../matlab/on_90_0.pdf}
        \subcaption{Sprungantwort mit ARW 90 \ldots 0}
        \label{fig:on_0_90}
    \end{minipage}
    \caption{Sprungantwort mit ARW}
    \label{fig:on}
\end{figure}

\clearpage

\appendix
\section{Matlab Skripts für Plots}
\lstsettingmatlab
\lstinputlisting{../matlab/lab7.m}
\lstinputlisting{../matlab/lab7.sh}

\section{Plots}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_0_90.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_0_90_p_i_d.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_0_90_r_y.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_0_90_u_usat.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_90_0.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_90_0_p_i_d.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_90_0_r_y.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/off_90_0_u_usat.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_0_90.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_0_90_p_i_d.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_0_90_r_y.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_0_90_u_usat.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_90_0.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_90_0_p_i_d.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_90_0_r_y.pdf}
\clearpage
\includegraphics[width=\textwidth]{../matlab/on_90_0_u_usat.pdf}

\end{document}
